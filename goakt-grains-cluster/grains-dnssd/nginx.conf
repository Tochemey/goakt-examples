events {}

stream {
  # Use CoreDNS to resolve the DNS-SD hostname
  resolver 172.28.0.10 valid=5s;
  resolver_timeout 2s;

  upstream accounts_upstream {
    zone accounts_upstream 64k;
    # "resolve" makes nginx pick among all IPs returned for the DNS-SD hostname
    server accounts.dnssd.local:50051 resolve;
  }

  # Expose gRPC (plaintext) on the same port your service uses
  server {
    listen 50051;
    proxy_pass accounts_upstream;
  }
}
